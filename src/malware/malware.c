#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define PKT_REPS 1
#define MAX_INPUT_SIZE 10000

void fill_packet(char *content, char *packet, int packet_len);
void tx_packet(char *packet, int packet_len);
uint16_t crc16(uint8_t *data_p, uint8_t length);

int main()
{
    // read input from stdin
    char input[MAX_INPUT_SIZE];
    scanf("%[^\t]", input);

    // compute packet length (in bytes) and allocate memory for it
    int packet_len = strlen(input) + 4; // add barker & checksum
    char *packet = malloc(packet_len);
    
    // fill the packet with desired content
    fill_packet(input, packet, packet_len);

    // send the packet a few times
    for (int i = 0; i < PKT_REPS; i++)
        tx_packet(packet, packet_len);
   
    // clean up
    free(packet);
    return 0;
}

void fill_packet(char *content, char *packet, int packet_len)
{
    // 13 bit barker, 3 bit zero pad
    packet[0] = 0xF9;
    packet[1] = 0xA8;

    // copy in the content
    strcpy(&packet[2], content);

    // append checksum
    uint16_t crc = crc16(content, strlen(content));
    packet[packet_len-2] = (char)(crc >> 8);
    packet[packet_len-1] = (char)(crc);

    return;
}

uint16_t crc16(uint8_t *data_p, uint8_t length)
{
    uint8_t x;
    uint16_t crc = 0xFFFF;
    while (length--) {
        x = crc >> 8 ^ *data_p++;
        x ^= x >> 4;
        crc = (crc<<8)^((uint16_t)(x<<12))^((uint16_t)(x<<5))^((uint16_t)x);
    }
    return crc;
}

void tx_packet(char *packet, int packet_len)
{
    // TODO add actual transmit code
    for (int i = 0; i < packet_len; i++)
        printf("%02hhX:",packet[i]);
    printf("\n");
    
    // also, dump content to binary file
    FILE *fptr;
    fptr = fopen("test.bin","wb");
    fwrite(packet, packet_len, 1, fptr);
    return;
}
