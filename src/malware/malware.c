#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define PKT_REPS 1
#define MAX_INPUT_SIZE 10000

short crc16(char *data)
{
    // define initial variables
    char length = strlen(data);
    char x;
    short crc = 0xFFFF;

    // calculate the CRC
    while (length--) {
        x = crc >> 8 ^ *data++;
        x ^= x >> 4;
        crc = (crc<<8) ^ ((short)(x<<12)) ^ ((short)(x<<5)) ^ ((short)x);
    }

    // return it
    return crc;
}

void packet_fill(char *packet, char *content, int packet_len)
{
    // copy in the 13-bit Barker code, and 3-bit zeropad
    packet[0] = 0xF9;
    packet[1] = 0xA8;

    // copy in the content
    strncpy(&packet[2], content, strlen(content));

    // append the checksum of the content
    short crc = crc16(content);
    packet[packet_len - 2] = (char)(crc >> 8);
    packet[packet_len - 1] = (char)(crc);
}

void packet_tx(char *packet, int packet_len)
{
    // print out transmit bits in hex
    for (int i = 0; i < packet_len; i++)
        printf("%02hhX:",packet[i]);
    printf("\n");
   
    // also, dump content to binary file
    FILE *fptr;
    fptr = fopen("test.bin","wb");
    fwrite(packet, packet_len, 1, fptr);
}

int calculate_final_packet_len(char *content)
{
    // add 2 bytes for padded Barker code
    // add 2 bytes for CRC16
    return strlen(content) + 4;
}

int main(int argc, char **argv)
{
    // we need exactly two arguments
    if (argc != 2) {
        return EXIT_FAILURE;
    }

    // the content to transmit can't exceed a certain length
    if (strlen(argv[1]) > MAX_INPUT_SIZE) {
        return EXIT_FAILURE;
    }

    // calculate the packet length
    // - two bytes extra for barker, two bytes extra for checksum
    int packet_len = calculate_final_packet_len(argv[1]);
    char *packet = malloc(packet_len);
    
    // fill the packet with content
    packet_fill(packet, argv[1], packet_len);

    // transmit the packet a few times
    for (int i = 0; i < PKT_REPS; i++)
        packet_tx(packet, packet_len);
 
    // clean up
    free(packet);
    return EXIT_SUCCESS;
}
