#!/bin/bash

# SETUP #######################################################################

# Read in arguments
bs_sml="$1"
bs_lrg="$2"
ct_sml="$3"
ct_lrg="$4"

# FUNCTIONS ###################################################################

# Drop the cache before we do reads
drop_cache () {
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches >& /dev/null
}

# Read through data and perform BFSK
bfsk () {
    for i in `seq 1 ${#stdin}`
    do
        case ${stdin:i-1:1} in
            1) dd if=/dev/sda2 iflag=direct,sync bs="$bs_sml" count="$ct_sml" >& /dev/null
                ;;
            0) dd if=/dev/sda2 iflag=direct,sync bs="$bs_lrg" count="$ct_lrg" >& /dev/null
                ;;
        esac
    done
}

# RUN SCRIPT ##################################################################

stdin=$(cat)
while true; do
    drop_cache  # Drop the cache before we perform BFSK
    time bfsk   # Modulate the hard drive LED
done
